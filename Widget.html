<!DOCTYPE html>
<html>
<head>
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.4.2/openseadragon.min.js"></script>
  <style>
    /* Estilos básicos e tamanho do widget */
    html, body { width: 710px; height: 500px; margin: 0; padding: 0; }
    #focus-container { width: 640px; height: 480px; margin: auto; }
    #slider-container { position: relative; width: 300px; height: 20px; margin: auto; transform: rotate(90deg); }
    #slider { width: 470px; height: 10px; transform: rotate(270deg); }
  </style>
</head>
<body>
  <div id="focus-container"></div>
  <div id="slider-container">
    <input type="range" id="slider" min="1" max="5" step="1" value="1">
  </div>

  <script type="text/javascript">
    JFCustomWidget.subscribe("ready", function() {
      // Configuração dos valores a partir das definições do widget no Jotform
      const hostAddress = JFCustomWidget.getWidgetSetting('hostAddress') || "https://github.com/Mardeserto/organoides.github.io/tree/main/images";
      const folderName = JFCustomWidget.getWidgetSetting('folderName') || "Organoid";
      const organoideNumber = JFCustomWidget.getWidgetSetting('organoid') || 1;
      const maxFocus = parseInt(JFCustomWidget.getWidgetSetting('maxFocus')) || 5;

      // Atualiza o valor máximo do slider com base no número de focos
      document.getElementById("slider").max = maxFocus;

      // Inicializa o OpenSeadragon
      const viewer = OpenSeadragon({
        id: "focus-container",
        prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/2.4.2/images/",
        tileSources: `${hostAddress}/${folderName}_${organoideNumber}/focus_1.xml`
      });

      // Função para salvar o estado de zoom
      function saveZoomState() {
        return { zoom: viewer.viewport.getZoom(), center: viewer.viewport.getCenter() };
      }

      // Função para restaurar o estado de zoom
      function restoreZoomState(state) {
        viewer.viewport.zoomTo(state.zoom, state.center);
      }

      // Monitora o slider para mudanças de foco
      document.getElementById("slider").addEventListener('input', function() {
        const focusLevel = this.value;
        const zoomState = saveZoomState();
        viewer.addTiledImage({
          tileSource: `${hostAddress}/${folderName}_${organoideNumber}/focus_${focusLevel}.xml`,
          success: function(event) {
            const tiledImage = event.item;
            restoreZoomState(zoomState);
            if (viewer.world.getItemCount() > 1) {
              const previousImage = viewer.world.getItemAt(0);
              viewer.world.removeItem(previousImage);
            }
          }
        });
      });

      // Prepara os dados para o formulário
      JFCustomWidget.subscribe("submit", function() {
        JFCustomWidget.sendSubmit({ valid: true, value: `${folderName}_${organoideNumber} Focus_${document.getElementById("slider").value}` });
      });
    });
  </script>
</body>
</html>
